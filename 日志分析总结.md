# DKT训练日志分析总结

## 一、关键问题发现

### 日志观察（Run 1）

```
Epoch 5:  Loss=0.2049, Val AUC=0.5036
Epoch 10: Loss=0.0104, Val AUC=0.5009  ← 损失下降98%，但AUC几乎不变
Epoch 15: Loss=0.0038, Val AUC=0.5018  ← 损失继续下降，AUC仍然0.50
Test:     AUC=0.4999, ACC=0.5722        ← 最终AUC接近随机猜测
```

### 🔴 核心问题：损失下降但AUC不提升

**现象**：
- 损失从0.20快速降到0.0038（下降98%）
- 但Val AUC始终在0.50左右（几乎没有变化）
- 最终测试AUC=0.4999（几乎等于随机猜测0.5）

**这说明了什么？**

模型可能学到了一个**简单的模式**（比如总是预测接近0.5），这个模式：
- 在训练集上损失低（因为标签均值约0.69，预测0.5的损失不会太高）
- 但在验证集上AUC不提升（因为预测没有区分度）

## 二、根本原因分析

### 原因1：DKT输入编码不正确（已修复）

**原始实现**：
```python
# 问题：只是简单拼接，没有交互
answer_embeds = answer_seq.unsqueeze(-1).float()
answer_embeds = answer_embeds.expand(-1, -1, embed_dim)
lstm_inputs = torch.cat([question_embeds, answer_embeds], dim=-1)
```

**修复后**（按照原始DKT论文）：
```python
# 正确：使用交互编码 [q*a, q*(1-a)]
input_correct = question_embeds * answer_expanded
input_wrong = question_embeds * (1 - answer_expanded)
lstm_inputs = torch.cat([input_correct, input_wrong], dim=-1)
```

### 原因2：可能的学习率问题

- 当前学习率：0.001
- 损失下降太快可能说明学习率太大
- 建议：尝试0.0001或使用学习率调度

### 原因3：训练轮数不足

- 虽然设置了50轮，但15轮就早停了
- 可能是因为AUC没有提升触发早停
- 修复输入编码后，可能需要更多轮数才能看到效果

## 三、已实施的修复

### ✅ 修复1：DKT输入编码

已按照原始DKT论文修复输入编码方式，使用交互式编码：
- `[question * answer, question * (1-answer)]`

这应该能让模型更好地学习问题和答案的交互关系。

## 四、建议的下一步

### 选项1：重新运行DKT测试（推荐）

修复输入编码后，重新运行快速测试：

```bash
# 快速测试：只运行DKT，1次运行，100轮训练
python experiments/run_baseline_experiments.py \
    --datasets assist09 \
    --models DKT \
    --n_runs 1 \
    --n_epochs 100
```

**预期结果**：
- 如果修复有效：AUC应该能提升到0.70+
- 如果仍然很低：需要进一步调查

### 选项2：继续当前实验

- 让DKVMN继续运行完成
- 然后重新运行DKT（使用修复后的代码）

## 五、其他可能的问题

### 1. Padding问题

当前padding在左侧（前面）添加0，这是正确的。但需要确保：
- 模型能正确处理padding的0值
- 或者使用mask忽略padding位置

### 2. 损失函数问题

当前使用BCE损失，这是正确的。但可能需要：
- 检查是否有类别不平衡问题
- 考虑使用加权损失

### 3. 模型容量问题

当前DKT参数：
- embed_dim=128, hidden_dim=256
- 对于ASSIST09（124个concepts）应该足够

## 六、验证修复效果

修复后，应该观察到：
1. ✅ 损失和AUC同步提升
2. ✅ 训练50轮后AUC达到0.70+
3. ✅ 训练100轮后AUC达到0.75-0.80
4. ✅ 预测值分布更合理（不是总是接近0.5）

## 七、如果修复后仍然有问题

如果修复输入编码后AUC仍然很低，需要检查：

1. **数据预处理**：
   - 验证Q-matrix是否正确
   - 验证target_concept映射是否正确

2. **模型实现**：
   - 验证LSTM输出是否正确
   - 验证输出层是否正确

3. **训练过程**：
   - 添加更多监控指标
   - 检查梯度是否正常
   - 检查是否有梯度消失/爆炸

