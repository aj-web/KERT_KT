# KER-KT模型预测范围问题分析

## 一、问题描述

从测试日志观察到：
- **初始预测范围**：0.495-0.537（非常接近0.5）
- **预测值标准差**：0.0027（非常小）
- **预测值分布**：75%在0.4-0.5之间，25%在0.5-0.6之间

这说明模型初始化后输出几乎都是0.5，没有区分度。

## 二、诊断结果

### 1. 模型初始化问题

**问题**：
- 使用Xavier初始化，可能导致初始输出集中在0.5附近
- Sigmoid激活函数会将输入映射到0-1，如果输入接近0，输出会接近0.5

**证据**：
- 初始预测值：0.4923-0.5033（几乎都是0.5）
- 标准差：0.0027（非常小）

### 2. L2正则化

**观察**：
- L2正则化项：142.58（所有参数的L2范数总和）
- 正则化系数：1e-5
- 实际正则化项：142.58 * 1e-5 ≈ 0.0014（不大）

**结论**：L2正则化不是主要问题

### 3. 训练过程

**观察**：
- 训练一步后，预测值范围变为：0.5501-0.7099
- 说明模型确实在更新
- 但初始状态太差，需要更多训练才能改善

### 4. 梯度更新

**观察**：
- 参数确实在更新（最大变化：0.001）
- 梯度存在但可能较小
- 最后一层bias的梯度：-0.247（较大，说明模型在调整）

## 三、修复方案

### 方案1：改进初始化（已实施）

**修改**：
1. Embedding层：使用较小的标准差（0.02）而不是Xavier
2. Predictor层：使用He初始化（适合ReLU）
3. 最后一层bias：初始化为0

**预期效果**：
- 初始预测值分布更均匀
- 避免初始输出集中在0.5

### 方案2：调整学习率

**建议**：
- 如果训练初期预测值仍然集中在0.5，可以：
  1. 增加初始学习率（如0.002）
  2. 使用学习率warmup
  3. 使用学习率调度器

### 方案3：调整模型架构

**可选**：
- 如果问题持续，可以考虑：
  1. 增加模型容量
  2. 调整dropout率
  3. 使用不同的激活函数

## 四、验证修复效果

### 快速测试

```bash
# 运行诊断脚本
python experiments/diagnose_kert_kt.py

# 检查：
# 1. 初始预测值范围是否更广
# 2. 预测值分布是否更均匀
# 3. 训练后预测值是否改善
```

### 预期结果

修复后应该观察到：
- ✅ 初始预测值范围：0.3-0.7（而不是0.49-0.50）
- ✅ 预测值标准差：> 0.05（而不是0.0027）
- ✅ 训练后AUC逐步提升

## 五、如果问题仍然存在

如果修复初始化后问题仍然存在，需要检查：

1. **数据问题**：
   - 检查标签分布是否平衡
   - 检查数据预处理是否正确

2. **训练策略**：
   - 增加训练轮数
   - 调整学习率
   - 使用不同的优化器

3. **模型架构**：
   - 检查模型容量是否足够
   - 检查是否有梯度消失/爆炸

